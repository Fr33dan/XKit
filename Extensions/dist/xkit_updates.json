{"id":"xkit_updates","script":"//* TITLE XKit Updates **//\r\n//* VERSION 2.0.1 **//\r\n//* DESCRIPTION Provides automatic updating of extensions **//\r\n//* DEVELOPER new-xkit **//\r\nXKit.extensions.xkit_updates = new Object({\r\n\r\n\trunning: false,\r\n\r\n\tdefault_interval: 18000000,\r\n\tmin_interval: 3600000,\r\n\tmax_interval: 86400000,\r\n\r\n\tpreferences: {\r\n\t\t\"show_notifications\": {\r\n\t\t\ttext: \"Show update notifications\",\r\n\t\t\tdefault: true,\r\n\t\t\tvalue: true\r\n\t\t},\r\n\t\t\"check_interval\": {\r\n\t\t\ttext: \"Update check interval (in milliseconds)\",\r\n\t\t\tdefault: \"18000000\",\r\n\t\t\tvalue: \"18000000\",\r\n\t\t\ttype: \"text\"\r\n\t\t},\r\n\t},\r\n\r\n\trun: function() {\r\n\t\ttry {\r\n\t\t\tXKit.tools.init_css(\"xkit_updates\");\r\n\t\t\tthis.running = true;\r\n\t\t\tvar d = new Date();\r\n\t\t\tvar ms = d.getTime();\r\n\t\t\tvar last_time = parseFloat(XKit.storage.get(\"xkit_updates\", \"last_update_check\", \"0\"));\r\n\t\t\tvar difference = ms - last_time;\r\n\t\t\tXKit.console.add(\"Updates: difference = \" + difference);\r\n\t\t\tif (isNaN(XKit.extensions.xkit_updates.preferences.check_interval.value) === true) {\r\n\t\t\t\tXKit.console.add(\"Invalid check interval, reverting to default: not a number.\");\r\n\t\t\t\tXKit.extensions.xkit_updates.preferences.check_interval.value = XKit.extensions.xkit_updates.default_interval;\r\n\t\t\t} else {\r\n\t\t\t\tvar m_interval = XKit.extensions.xkit_updates.preferences.check_interval.value;\r\n\t\t\t\tif (m_interval > XKit.extensions.xkit_updates.max_interval || m_interval < XKit.extensions.xkit_updates.min_interval) {\r\n\t\t\t\t\tXKit.extensions.xkit_updates.preferences.check_interval.value = XKit.extensions.xkit_updates.default_interval;\r\n\t\t\t\t\tXKit.console.add(\"Invalid check interval, reverting to default: too small or big.\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (difference <= -1 ||difference >= XKit.extensions.xkit_updates.preferences.check_interval.value) {\r\n\t\t\t\tXKit.console.add(\"Starting update checking..\");\r\n\t\t\t\tXKit.extensions.xkit_updates.get_list();\r\n\t\t\t} else {\r\n\t\t\t\tXKit.console.add(\"Skipping update checking.\");\r\n\t\t\t}\r\n\t\t} catch(e) {\r\n\t\t\tXKit.extensions.xkit_updates.show_update_failure();\r\n\t\t}\r\n\t},\r\n\r\n\tto_update: \"\",\r\n\tto_update_index: 0,\r\n\tupdated_list: \"\",\r\n\tupdated_list_versions: \"\",\r\n\r\n\tget_list: function(force_mode) {\r\n\r\n\t\tif (force_mode) {\r\n\t\t\t$(\"#xkit-forced-auto-updates-message\").html(\"Fetching the latest changes from XKit servers...\");\r\n\t\t}\r\n\r\n\t\tXKit.download.page(\"list.php\", function(mdata) {\r\n\r\n\t\t\tif (mdata.server_down === true) {\r\n\r\n\t\t\t\tXKit.extensions.xkit_updates.show_update_failure();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tXKit.extensions.xkit_updates.to_update_index = 0;\r\n\t\t\tXKit.extensions.xkit_updates.to_update = [];\r\n\t\t\tXKit.extensions.xkit_updates.updated_list = [];\r\n\t\t\tXKit.extensions.xkit_updates.updated_list_versions = [];\r\n\r\n\t\t\tfor(var extension in mdata.extensions) {\r\n\r\n\t\t\t\tif (force_mode) {\r\n\r\n\t\t\t\t\tvar check_this = false;\r\n\t\t\t\t\tif (XKit.installed.check(mdata.extensions[extension].name)) {\r\n\r\n\t\t\t\t\t\tif (XKit.extensions.xkit_updates.shouldUpdate(XKit.tools.parse_version(XKit.installed.get(mdata.extensions[extension].name).version), XKit.tools.parse_version(mdata.extensions[extension].version))) {\r\n\t\t\t\t\t\t\tcheck_this = true;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tif (mdata.extensions[extension].name.substring(0,5) === \"xkit_\") {\r\n\t\t\t\t\t\t\t// Always update internals no matter what.\r\n\t\t\t\t\t\t\tcheck_this = true;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tif (check_this) {\r\n\t\t\t\t\t\t\tXKit.extensions.xkit_updates.to_update.push(mdata.extensions[extension].name);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\tif (XKit.installed.check(mdata.extensions[extension].name)) {\r\n\t\t\t\t\t\tif (XKit.extensions.xkit_updates.shouldUpdate(XKit.tools.parse_version(XKit.installed.get(mdata.extensions[extension].name).version), XKit.tools.parse_version(mdata.extensions[extension].version))) {\r\n\t\t\t\t\t\t\tXKit.extensions.xkit_updates.to_update.push(mdata.extensions[extension].name);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\tif (XKit.extensions.xkit_updates.to_update.length > 0) {\r\n\t\t\t\t$(\"body\").append(\"<div id=\\\"xkit-updating-indicator\\\">XKit Auto-Update</div>\");\r\n\t\t\t\tif (force_mode) {\r\n\t\t\t\t\t$(\"#xkit-forced-auto-updates-message\").html(\"Downloading extensions from the servers...\");\r\n\t\t\t\t}\r\n\t\t\t\tXKit.extensions.xkit_updates.update_next(force_mode);\r\n\t\t\t} else {\r\n\t\t\t\tvar d = new Date();\r\n\t\t\t\tvar ms = d.getTime();\r\n\t\t\t\tXKit.storage.set(\"xkit_updates\", \"last_update_check\", ms);\r\n\t\t\t\tXKit.console.add(\"Update complete: no new extensions\");\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t},\r\n\r\n\tshow_update_failure: function() {\r\n\r\n\t\tXKit.notifications.add(\"<b>Could not update XKit:</b><br/>I could not reach the XKit servers to update myself. You might be running an old and buggy version of XKit. Click here for details.\", \"error\", true, function() {\r\n\r\n\t\t\tXKit.window.show(\"Auto-Update failed.\",\"XKit automatically updates itself from time to time in the background to bring you the latest features and bug fixes. Unfortunately, it was unable to contact the servers and download the latest updates. This might be a temporary server error or a problem with your connection.<br/><br/><b>If you have received this message more than twice in the last three days, it is highly recommended that you reset XKit.</b> If you don't, you'll be running an out-of-date XKit which might not work properly and cause problems.\",\"error\",\"<div class=\\\"xkit-button default\\\" id=\\\"xkit-close-message\\\">OK</div><a href=\\\"http://www.tumblr.com/xkit_reset\\\" class=\\\"xkit-button\\\">Reset XKit</a>\");\r\n\r\n\t\t});\r\n\r\n\t},\r\n\r\n\tupdate_next: function(force_mode) {\r\n\r\n\t\tif (XKit.extensions.xkit_updates.to_update_index >= XKit.extensions.xkit_updates.to_update.length) {\r\n\r\n\t\t\tvar d = new Date();\r\n\t\t\tvar ms = d.getTime();\r\n\t\t\tXKit.storage.set(\"xkit_updates\", \"last_update_check\", ms);\r\n\r\n\t\t\t// Completed all?\r\n\r\n\t\t\tif (!force_mode) {\r\n\r\n\t\t\t\tvar to_show = XKit.tools.get_setting(\"xkit_show_update_notifications\",\"true\");\r\n\r\n\t\t\t\tif (to_show === \"true\") {\r\n\r\n\t\t\t\t\tXKit.notifications.add(\"XKit updated \" + XKit.extensions.xkit_updates.updated_list.length + \" extension(s). Click here to view them.\", \"ok\", true, function() {\r\n\t\t\t\t\t\tvar m_result = \"\";\r\n\t\t\t\t\t\tfor (i=0;i<XKit.extensions.xkit_updates.updated_list.length;i++) {\r\n\t\t\t\t\t\t\tm_result = m_result + \"<br/>\" + XKit.extensions.xkit_updates.updated_list[i] + \" &middot; \" + XKit.extensions.xkit_updates.updated_list_versions[i];\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tXKit.window.show(\"Auto-Update results\",\"<b>XKit updated the following extension(s):</b>\" + m_result, \"info\", \"<div class=\\\"xkit-button default\\\" id=\\\"xkit-close-message\\\">OK</div>\");\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\tXKit.window.show(\"Complete!\",\"<b>XKit updated all the extensions with version mismatch.</b><br/>Changes will be active when you refresh the page.\",\"info\",\"<div id=\\\"xkit-close-message\\\" class=\\\"xkit-button default\\\">OK</div>\");\r\n\r\n\t\t\t}\r\n\r\n\t\t\t$(\"#xkit-updating-indicator\").remove();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (force_mode) {\r\n\t\t\t$(\"#xkit-forced-auto-updates-message\").html(\"Downloading \" + XKit.extensions.xkit_updates.to_update[XKit.extensions.xkit_updates.to_update_index] + \" (\" + (XKit.extensions.xkit_updates.to_update_index + 1) + \" of \" + XKit.extensions.xkit_updates.to_update.length + \")\");\r\n\t\t}\r\n\r\n\r\n\t\tXKit.extensions.xkit_updates.update(XKit.extensions.xkit_updates.to_update[XKit.extensions.xkit_updates.to_update_index], function(mdata) {\r\n\r\n\t\t\tif (mdata.errors === true) {\r\n\t\t\t\tif (mdata.error_not_found === true) {\r\n\t\t\t\t\t// Probably removed.\r\n\t\t\t\t\tXKit.console.add(\"Can not update \" + XKit.extensions.xkit_updates.to_update[XKit.extensions.xkit_updates.to_update_index] + \": not found.\");\r\n\t\t\t\t}else{\r\n\t\t\t\t\tXKit.extensions.xkit_updates.show_update_failure();\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tXKit.extensions.xkit_updates.updated_list.push(mdata.title);\r\n\t\t\tXKit.extensions.xkit_updates.updated_list_versions.push(mdata.version);\r\n\t\t\tXKit.console.add(\"Updated \" + XKit.extensions.xkit_updates.to_update[XKit.extensions.xkit_updates.to_update_index]);\r\n\t\t\tXKit.extensions.xkit_updates.to_update_index++;\r\n\t\t\tXKit.extensions.xkit_updates.update_next(force_mode);\r\n\r\n\t\t});\r\n\r\n\t},\r\n\r\n\tupdate: function(extension_id, callback) {\r\n\r\n\t\tvar m_result = {};\r\n\r\n\r\n\t\tXKit.install(extension_id, function(mdata) {\r\n\r\n\t\t\tif (mdata.errors) {\r\n\t\t\t\tif (mdata.storage_error === true) {\r\n\t\t\t\t\tm_result.errors = true;\r\n\t\t\t\t\tm_result.error = \"Can't store data on browser\";\r\n\t\t\t\t\tcallback(m_result);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tif (mdata.server_down === true) {\r\n\t\t\t\t\tm_result.errors = true;\r\n\t\t\t\t\tm_result.error = \"Can't reach servers\";\r\n\t\t\t\t\tcallback(m_result);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (mdata.file === \"not_found\") {\r\n\t\t\t\t\t\tm_result.errors = true;\r\n\t\t\t\t\t\tm_result.error_not_found = true;\r\n\t\t\t\t\t\tm_result.error = \"Extension can't be found: It might've been removed from the extension gallery.\";\r\n\t\t\t\t\t\tcallback(m_result);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tm_result.errors = true;\r\n\t\t\t\t\t\tm_result.error = \"Unknown error. Code: #UPDATE-1026\";\r\n\t\t\t\t\t\tcallback(m_result);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\ttry {\r\n\t\t\t\t// Try evaling the script.\r\n\t\t\t\t// If it's working, then move to the next one.\r\n\t\t\t\tm_result.errors = false;\r\n\t\t\t\tm_result.error = \"\";\r\n\t\t\t\tm_result.title = mdata.title;\r\n\t\t\t\tm_result.version = mdata.version;\r\n\t\t\t\tcallback(m_result);\r\n\t\t\t} catch(e) {\r\n\t\t\t\tm_result.errors = true;\r\n\t\t\t\tm_result.error = \"UP-ER:\" + e.message;\r\n\t\t\t\tcallback(m_result);\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t},\r\n\r\n\tshouldUpdate: function(versionCurrent, versionRemote) {\r\n\t\tif (versionRemote.major > versionCurrent.major) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\tif ((versionRemote.minor > versionCurrent.minor) && (versionRemote.major >= versionCurrent.major)) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\tif ((versionRemote.patch > versionCurrent.patch) && (versionRemote.major >= versionCurrent.major) && (versionRemote.minor >= versionCurrent.minor)) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t},\r\n\t\r\n\tdestroy: function() {\r\n\t\tthis.running = false;\r\n\t}\r\n\r\n});\r\n","file":"found","server":"up","errors":false,"css":"#xkit-updating-indicator {\r\n\tposition: fixed;\r\n\ttop: 10px; left: 10px;\r\n\tbackground: rgba(0,0,0,0.22) no-repeat 5px 50% url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6QUI1QzFEQjdENjg5MTFFMkEzMDdEMENERTdFNEZBNEYiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6QUI1QzFEQjhENjg5MTFFMkEzMDdEMENERTdFNEZBNEYiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpBQjVDMURCNUQ2ODkxMUUyQTMwN0QwQ0RFN0U0RkE0RiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpBQjVDMURCNkQ2ODkxMUUyQTMwN0QwQ0RFN0U0RkE0RiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pno+M+4AAAD2SURBVHjanFIxCsJAEMwJtskL7hfp7f1EwGfkDYLvSJHGWrDT0sMqjRCwSRdQSZFA4k6yd1zOKMGFyS07M9lj90TXdd4/scBHCGFAERGOhJKBPHI0nqc70hkQLt33ABcYjza2batsVVmWN8CuQTMyEiJbUNf1K47jDYDc6RwZY1VVJ5tJ03RLP/YB5DbH2sHYNM1TE1mWHcggrQHKPM/PmmftYJy4jtmRW2ftsA4MYe7+tLY3KqX2c41Gy7eS7uingrvJ0R7DMFz/MoOD5uMBUCwJqyRJdkVRXDEEADlq4FjTe4T7yOktSl6Hz6UH4U66u617CzAAsTaRsb/W8BoAAAAASUVORK5CYII=');\r\n\twidth: auto; height: 20px;\r\n\tline-height: 20px;\r\n\tpadding-left: 24px;\r\n\tpadding-right: 8px;\r\n\tcolor: white;\r\n\ttext-shadow: 0px 1px 0px rgba(0,0,0,0.12);\r\n\tfont-size: 11px;\r\n\tborder-radius: 20px;\r\n\topacity: 0.7;\r\n}\r\n\r\n#xkit-updating-indicator:hover {\r\n\topacity: 1;\r\n}","title":"XKit Updates","description":"Provides automatic updating of extensions","developer":"new-xkit","version":"2.0.1","frame":"false","beta":"false","slow":"false"}