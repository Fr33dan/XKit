{"id":"editable_reblogs","script":"//* TITLE Editable Reblogs **//\r\n//* VERSION 2.1.3 **//\r\n//* DESCRIPTION\tRestores ability to edit previous reblogs of a post **//\r\n//* DEVELOPER new-xkit **//\r\n//* FRAME false **//\r\n//* BETA false **//\r\n\r\nXKit.extensions.editable_reblogs = new Object({\r\n\r\n\trunning: false,\r\n\r\n\trun: function() {\r\n\t\tthis.running = true;\r\n\r\n\t\tXKit.interface.post_window_listener.add(\"editable_reblogs\", XKit.extensions.editable_reblogs.post_window);\r\n\t\tXKit.tools.add_css(\".control-reblog-tree {display: none; } .post-form--header .reblog-title {margin: 10px; color: #444} \", \"editable_reblogs_remove_content_tree\");\r\n\r\n\t\tvar pat_ver = XKit.tools.parse_version(XKit.installed.get(\"xkit_patches\").version);\r\n\t\tif (pat_ver.major <=5 && pat_ver.minor <= 3 && pat_ver.patch <= 0){\r\n\t\t\tXKit.extensions.xkit_updates.update('xkit_patches', function(result){\r\n\t\t\t\tif(result.errors){\r\n\t\t\t\t\tXKit.window.show('Updating error', 'ERROR: Editable Reblogs does not support your version of XKit Patches, '+\r\n\t\t\t\t\t'and cannot automatically update it.<br><br>'+\r\n\t\t\t\t\t\"Try force updating all extensions from the gallery, and if that fails, try uninstalling and reinstalling XKit.\",\r\n\t\t\t\t\t'error', \"<div id=\\\"xkit-close-message\\\" class=\\\"xkit-button\\\">OK</div>\");\r\n\t\t\t\t} else {\r\n\t\t\t\t\twindow.location = window.location;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t},\r\n\r\n\tpost_window: function() {\r\n\t\tvar is_legacy = $(\".reblog-tree\").length > 0;\r\n\t\tif (is_legacy) {\r\n\t\t\tXKit.extensions.editable_reblogs.post_window_legacy();\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tvar reblog_tree = $(\".post-form .reblog-list\");\r\n\r\n\t\tvar all_quotes = [];\r\n\t\tvar old_content = '';\r\n\t\tvar all_quotes_text = '';\r\n\t\t// Guard against double evaluation by marking the tree as processed\r\n\t\tvar processed_class = 'xkit-editable-reblogs-done';\r\n\t\tif (reblog_tree.length > 0) {\r\n\t\t\tif (reblog_tree.hasClass(processed_class)) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\treblog_tree.addClass(processed_class);\r\n\r\n\t\t\tvar title = reblog_tree.find('.reblog-title');\r\n\t\t\t$('.post-form--header').append(title);\r\n\t\t\treblog_tree.find(\".reblog-list-item\").each(function(index) {\r\n\t\t\t\tvar reblog_data = {\r\n\t\t\t\t\treblog_content: $(this).find('.reblog-content').html() ? $(this).find('.reblog-content').html() : '',\r\n\t\t\t\t\treblog_author: $(this).find('.reblog-tumblelog-name').text() ? $(this).find('.reblog-tumblelog-name').text() : '',\r\n\t\t\t\t\treblog_url: $(this).find('.reblog-tumblelog-name').attr('href') ? $(this).find('.reblog-tumblelog-name').attr('href') : ''\r\n\t\t\t\t};\r\n\t\t\t\tall_quotes.push(reblog_data);\r\n\t\t\t});\r\n\t\t\tall_quotes.forEach(function(data, index, all) {\r\n\t\t\t\tvar reblog_content = data.reblog_content.replace(\"tmblr-truncated read_more_container\", \"\");\r\n\t\t\t\t//don't wrap if the previous user didn't add a comment\r\n\t\t\t\tif (reblog_content.indexOf(\"</blockquote>\", reblog_content.length - 13) !== -1 || reblog_content.length === 0) {\r\n\t\t\t\t\tall_quotes_text = reblog_content;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tall_quotes_text = \"<p><a class='tumblr_blog' href='\" + data.reblog_url + \"'>\" + data.reblog_author + \"</a>:</p><blockquote>\" + all_quotes_text + reblog_content + \"</blockquote>\";\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\ttry {\r\n\t\t\told_content = XKit.interface.post_window.get_content_html();\r\n\t\t} catch (e) {\r\n\t\t\tXKit.window.show('Invalid editor type', 'ERROR: Editable Reblogs cannot currently get content from your default editor type. '+\r\n\t\t\t\t'To continue using editable reblogs, click <a target=\"_blank\" href=\"https://www.tumblr.com/settings/dashboard\">here</a> '+\r\n\t\t\t\t'to edit your dashboard settings to use the rich text editor or HTML editor',\r\n\t\t\t\t'error', \"<div id=\\\"xkit-close-message\\\" class=\\\"xkit-button\\\">OK</div>\");\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t// add 'tumblr_blog' class to all tumblr.com links,\r\n\t\t// assuming that they're part of a reblog-structure that's not being parsed properly\r\n\t\tvar nodes = $(all_quotes_text + old_content);\r\n\t\tnodes.find('a[href*=\"tumblr.com\"]').addClass('tumblr_blog');\r\n\t\tvar nodes_text = $('<div>').append($(nodes).clone()).html();\r\n\t\tXKit.interface.post_window.set_content_html(nodes_text);\r\n\t\t//run submission cleanup before post is submitted\r\n\t\t$('.controls-container').on('click', '.create_post_button', XKit.extensions.editable_reblogs.process_submit);\r\n\r\n\t\t$(\".btn-remove-trail .icon\").click();\r\n\t\t$(\".control-reblog-trail\").hide();\r\n\t},\r\n\tprocess_submit: function(e) {\r\n\t\te.preventDefault();\r\n\t\t// use the HTML editor, even if we're on rich-text\r\n\t\t// (adding content to the rich text editor changes 'tumblr_blog' back to \"tumblr_blog\")\r\n\t\tif ($(\".html-field\").css(\"display\") === \"none\") {\r\n\t\t\t// tumblr_blog must be wrapped in single quotes, not double, or the dash will nom the shit out of your post\r\n\t\t\tvar text = XKit.interface.post_window.get_content_html();\r\n\t\t\t//********* DO ANY DOM MANIPULATION FIRST *************\r\n\t\t\t//******if done later it will undo the single quote fix*********\r\n\t\t\tvar nodes = $('<div>').append($(text));\r\n\t\t\tnodes.find('.tmblr-truncated').replaceWith('[[MORE]]');\r\n\t\t\ttext = nodes.html();\r\n\t\t\t//********ALL DOM MANIPULATION ABOVE THIS LINE*********\r\n\t\t\ttext = text.replace(/\"tumblr_blog\"/g, \"'tumblr_blog'\");\r\n\t\t\t// also remove empty HTML if the user hasn't added anything\r\n\t\t\tif (text.indexOf(\"<p><br></p>\", text.length - 11) !== -1) {\r\n\t\t\t\ttext = text.substring(0, text.length - 11);\r\n\t\t\t}\r\n\t\t\tXKit.tools.add_function(function(){\r\n\t\t\t\tvar new_content = add_tag[0];\r\n\t\t\t\tvar editor_div = document.getElementsByClassName(\"ace_editor\");\r\n\t\t\t\tif (editor_div.length === 1) {\r\n\t\t\t\t\tvar editor = window.ace.edit(editor_div[0]);\r\n\t\t\t\t\teditor.setValue(new_content);\r\n\t\t\t\t\tsetTimeout(function(){\r\n\t\t\t\t\t\tjQuery(\".ace_marker-layer\").empty();\r\n\t\t\t\t\t}, 500);\r\n\t\t\t\t}\r\n\t\t\t}, true, [text]);\r\n\t\t} else {\r\n\t\t\tXKit.tools.add_function(function(){\r\n\t\t\t\tvar editor_div = document.getElementsByClassName(\"ace_editor\");\r\n\t\t\t\tif (editor_div.length === 1) {\r\n\t\t\t\t\tvar editor = window.ace.edit(editor_div[0]);\r\n\t\t\t\t\tvar content = editor.getValue();\r\n\t\t\t\t\t// tumblr_blog must be wrapped in single quotes, not double, or the dash will nom the shit out of your post\r\n\t\t\t\t\tcontent = content.replace(/\"tumblr_blog\"/g, \"'tumblr_blog'\");\r\n\t\t\t\t\teditor.setValue(content);\r\n\t\t\t\t\tsetTimeout(function(){\r\n\t\t\t\t\t\tjQuery(\".ace_marker-layer\").empty();\r\n\t\t\t\t\t}, 500);\r\n\t\t\t\t}\r\n\t\t\t}, true, []);\r\n\t\t}\r\n\t},\r\n\tpost_window_legacy: function() {\r\n\t\tvar reblog_tree = $(\".reblog-tree\");\r\n\t\tif (reblog_tree.length <= 0) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Guard against double evaluation by marking the tree as processed\r\n\t\tvar processed_class = 'xkit-editable-reblogs-done';\r\n\t\tif (reblog_tree.hasClass(processed_class)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\treblog_tree.addClass(processed_class);\r\n\r\n\t\t// Convert all of the user links to have class tumblr_blog\r\n\t\tvar top_quote_link = reblog_tree.find('p:first-child > a:first-child');\r\n\t\tvar quote_links = reblog_tree.find('blockquote > p:first-child > a:first-child');\r\n\r\n\t\tif (top_quote_link.length > 0) {\r\n\t\t\t$(top_quote_link[0]).addClass('tumblr_blog');\r\n\t\t}\r\n\t\tquote_links.each(function() {\r\n\t\t\t$(this).addClass('tumblr_blog');\r\n\t\t});\r\n\r\n\t\tvar reblog_content = reblog_tree.html();\r\n\r\n\t\tvar old_content = XKit.interface.post_window.get_content_html();\r\n\t\tXKit.interface.post_window.set_content_html(reblog_content + old_content);\r\n\r\n\t\t$(\".btn-remove-tree\").click();\r\n\t},\r\n\tdestroy: function() {\r\n\t\tthis.running = false;\r\n\t\tXKit.tools.remove_css(\"editable_reblogs_remove_content_tree\");\r\n\t\tXKit.interface.post_window_listener.remove(\"editable_reblogs\");\r\n\t}\r\n});\r\n","file":"found","server":"up","errors":false,"icon":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAA4VBMVEUAAAAAAQEBAgICBAQCBQYDBggEBwkHDRAHDhIIEBQIEBUJEhYKFhALFRoLFRsMGRUNGSAPIRgQHycYLzsYNScbNkMcNkQcN0UdOEYdOEceOkgfPUwfPU0gPk0gPk4gP08hQFAiQlMjTTgjTTkkTjktV20tWG4yYXoyYns4bIg7co9Bfp9Bj2lEhKZFhqdFh6lFh6pHiq1JjrJJj7NMlLpNlbtNlrtNlrxNl7pNl7tNmLpOmLlQpKpQpalRpqZRpqdRp6VSqaNSsoNTr5tTsJpTsZhTsZlUspdUsphWu4lWvIqrAtY3AAABFklEQVR42qXQa1OCQBiG4cdKOtn5bEmaZklaZi5v27kgi/3/PygY9l1g02Gm7m/wXMPsAippCpBlYCJLgGIxE6hPWQTfyooFA/W7txIQ+DZ4pCzeC4DyIJRkg/c80Ltodg14sf/ka7yfotLV4Inonmi0Pw9ua0DjPaBynoJ4/yI6gGn3Q7R6iWhoICeKqIqhuUbkLjmxaIgU+KGKAaD3BxV1Vr2Vhd5YpGfwA5UEKF3UrnnrQIuv+awYmL0f78n3p34hOqv1N3jXZwjyZ3AXvTXAFdcZIBlm4AZzy8l+u8kgFQZcAMlO22CQCgOOATQFPxpA5s3OyeWQaAbg/giqGOT2Kzg2qKNY3QajQwdZztEdg5L+D34AmZvHFbsM2NwAAAAASUVORK5CYII=\r\n","title":"Editable Reblogs","description":"Restores ability to edit previous reblogs of a post","developer":"new-xkit","version":"2.1.3","frame":"false","beta":"false","slow":"false"}